def changeCount = 0
def hasChanges = false

pipeline {
    agent any

    environment {
        ENV = "dev" // "dev" || "prod"

        GIT_REPO_URL = 'https://github.com/HaeahnDev/Project-Vanilla.git'
        GIT_PROJECT_NAME = 'vanilla_springboot' // Docker Build 소문자 사용 ( ERROR: invalid tag "<이미지>:<태그>": repository name must be lowercase
        GIT_BRANCH = 'main'
        CREDENTIALS_ID = 'github_token'

        // WORKSPACE 분리를 위한 경로 설정
        WORKSPACE_PATH = "/var/lib/jenkins/workspace/${JOB_NAME}_${GIT_PROJECT_NAME}"
        // WORKSPACE 와 GIT REPO 공간 분리
        LOCAL_PATH = '/codeH'
        PROJECT_PATH = "${LOCAL_PATH}/project/${GIT_PROJECT_NAME}"

        // Docker Image = <Image Name>:<Image Tag>
        DOCKER_IMAGE_NAME = "${GIT_PROJECT_NAME}"
        DOCKER_IMAGE_TAG = "latest"
        // DOCKER_IMAGE_TAG = "${BUILD_NUMBER}"
        DOCKER_CONTAINER_NAME = "${GIT_PROJECT_NAME}"

        HOST_PORT = "12000"
        // springboot 기본 포트 = 8080
        CONTAINER_PORT = "8080"

        // COPY + MOUNT
        HOST_RESOURCES_PATH = "${LOCAL_PATH}/config/java_springboot"
        HOST_LOGS_PATH = "${LOCAL_PATH}/logs"

        // JAVA 옵션
        GRADLE_OPTS = "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"
        JAVA_OPTS = "-Xms1g -Xmx2g"
    }

    options {
        skipDefaultCheckout(true) // 기본 checkout 방지, manually checkout scmGit 실행
        timestamps() // 로그에 시간 추가
        timeout(time: 30, unit: 'MINUTES') // 빌드 제한시한 설정 // 10분 초과하는 듯..
        disableConcurrentBuilds() // 동시 빌드 방지(동시성 이슈 방지)
        buildDiscarder(logRotator(daysToKeepStr: '30', numToKeepStr: '10'))
        skipStagesAfterUnstable() // unstable stage 이후 skip - 테스트 실패 이후 추가 작업 중단
    }

    stages {
        stage('Initialize') {
            steps {
                echo "[Stage] === Pipeline Initialization ==="
                echo "PROJECT: ${GIT_PROJECT_NAME}"
                echo "Build Number: ${BUILD_NUMBER}"
                echo "Build URL: ${BUILD_URL}"
                echo "Workspace: ${WORKSPACE}"
                echo "Custom Workspace Path: ${WORKSPACE_PATH}"

                script {
                    // 시스템 체크 (리눅스용)
                    sh '''
                        echo === System Check ===
                        docker --version || echo "Docker not found"
                        java -version || echo "Java not found"
                        pwd
                        echo "Directory contents:"
                        ls -al
                        echo "Available disk space:"
                        df -h
                        echo "Memory usage:"
                        free -h || echo "Memory info not available"
                    '''
                }
            }
        }

        // 동시성 제어
        stage('Setup Workspace') {
            steps {
                script {
                    echo "[Stage] === Setting up custom workspace ==="

                    // 커스텀 워크스페이스 디렉토리 생성
                    sh """
                        rm -rf "${WORKSPACE_PATH}" || true
                        mkdir -p "${WORKSPACE_PATH}"
                        echo "Workspace directory created: ${WORKSPACE_PATH}"
                    """

                    // 현재 작업 디렉토리를 커스텀 워크스페이스로 변경
                    dir("${WORKSPACE_PATH}") {
                        sh "pwd && ls -la"
                    }
                }
            }
        }







        stage('Checkout Source Code') {
            steps {
                script {
                    echo "[Stage] === Checking out source code ==="
                    // 커스텀 워크스페이스에서 소스코드 체크아웃
                    dir("${PROJECT_PATH}") {


                        //git branch: "${env.GIT_BRANCH}", credentialsId: "${env.CREDENTIALS_ID}", url: "${env.GIT_REPO_URL}"
                        checkout scmGit(
                            branches: [[name: "*/${env.GIT_BRANCH}"]],
                            extensions: [],
                            userRemoteConfigs: [[
                                credentialsId: "${env.CREDENTIALS_ID}",
                                url: "${env.GIT_REPO_URL}"
                            ]]
                        )
                        // 변경된 커밋 수 확인
                        def changeLogSets = currentBuild.changeSets
                        changeCount = changeLogSets.size()

                        for (changeSet in currentBuild.changeSets) {
                            if (!changeSet.isEmptySet()) {
                                hasChanges = true
                                break
                            }
                        }
                    }
                }
            }
        }

        // 빌드 시 필요 파일 준비 - resource/*.yml, libs/*.jar, ...
        // cf) resource/*.yml : docker run -v 마운트로 덮어쓰기
        stage('Prepare Configurations') {
            //when {
            //    expression { changeCount > 0 }
            //}
            steps {
                echo "[Stage] === Prepare Configurations(Optional) ==="
                script {
                    dir("${PROJECT_PATH}") {
                        // 경로 생성
                        sh "mkdir -p src/main/resources"

                        // 파일 복사 - resources
                        sh """
                            if [ -d "${HOST_RESOURCES_PATH}" ] && [ "\$(ls -A ${HOST_RESOURCES_PATH} 2>/dev/null)" ]; then
                                cp -r ${HOST_RESOURCES_PATH}/default/resources/*.yml src/main/resources/
                                echo "Resources copied successfully"
                            else
                                echo "No resources found in ${HOST_RESOURCES_PATH}"
                            fi
                        """

                        // 파일 권한 설정
                        sh "chmod +x gradlew || true"
                    }
                }
            }
        }

        //stage('Code Quality Check(Optional - Linux)') {
        //    //when {
        //    //    expression { changeCount > 0 && !params.SKIP_TESTS }
        //    //}
        //    steps {
        //        script {
        //            echo "[Stage] === Code Quality Check ==="
        //
        //            dir("${PROJECT_PATH}") {
        //                // 코드 스타일 검사 (예: Checkstyle)
        //                sh """
        //                    ./gradlew checkstyleMain checkstyleTest || echo "Checkstyle check completed"
        //                """
        //                // 테스트 실행
        //                sh """
        //                    ./gradlew test --no-daemon --parallel || echo "Tests completed"
        //                """
        //                // 테스트 결과 수집
        //                // publishTestResults testResultsPattern: '**/build/test-results/test/**/*.xml'
        //                junit '**/build/test-results/test/**/*.xml'
        //            }
        //        }
        //    }
        //}

        stage('Docker Build') {
            //when {
            //    expression { changeCount > 0 }
            //}
            steps {
                script {
                    echo "[Stage] === Docker Build ==="
                    dir("${PROJECT_PATH}") {
                        // sh "docker build --no-cache -f Dockerfile -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} ."
                        dockerImage = docker.build("${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}", "--no-cache -f Dockerfile .")

                        // 빌드된 이미지 정보 출력
                        sh """
                            docker images ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}
                            docker history ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} --no-trunc
                        """
                    }
                }
            }
        }

        //stage('Docker Image Test') {
        //    when {
        //        allOf {
        //            environment name: "ENV", value: "dev"
        //            expression { changeCount > 0 }
        //        }
        //    }
        //    steps {
        //        script {
        //            echo "[Stage] === Testing Docker image ==="
        //            sh """
        //                docker run --rm ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} java -version
        //                docker run --rm ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} echo "Container test successful"
        //            """
        //        }
        //    }
        //}

        stage('Deploy Application') {
            //when {
            //    expression { changeCount > 0 }
            //}
            steps {
                echo "[Stage] === Deploy Application ==="

                // // 모든 오류 무시 - 컨테이가 존재하지 않는 경우 등
                // catchError(buildResult: 'SUCCESS', stageResult: 'SUCCESS') {
                //     sh '''
                //         docker stop $DOCKER_CONTAINER_NAME 2>/dev/null || echo "Container not running"
                //         docker rm $DOCKER_CONTAINER_NAME 2>/dev/null || echo "Container not found"
                //     '''
                // }

                // 기존 컨테이너 정리
                sh """
                    if docker ps -a --format '{{.Names}}' | grep -w "${DOCKER_CONTAINER_NAME}" >/dev/null 2>&1; then
                        docker stop ${DOCKER_CONTAINER_NAME} 2>/dev/null || echo "Container not running"
                        docker rm ${DOCKER_CONTAINER_NAME} 2>/dev/null || echo "Container not found"
                    else
                        echo "Container ${DOCKER_CONTAINER_NAME} does not exist. Skipping stop and rm."
                    fi
                """

                // 리소스 디렉토리 존재 확인 및 생성
                sh """
                    if [ ! -d "${HOST_RESOURCES_PATH}" ]; then
                        mkdir -p "${HOST_RESOURCES_PATH}"
                    fi
                """
                // 컨테이너 실행
                // -p ${HOST_PORT}:${CONTAINER_PORT} \\ host 사용 시 포트 지정 불가
                sh """
                    docker run -d --name ${DOCKER_CONTAINER_NAME} \\
                        --restart unless-stopped \\
                        -p ${HOST_PORT}:${CONTAINER_PORT}
                        -v ${HOST_RESOURCES_PATH}/default/resources:/config \\
                        -v ${HOST_LOGS_PATH}:/logs \\
                        -e JAVA_OPTS="${JAVA_OPTS}" \\
                        ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} \\
                        --spring.config.location=classpath:/,file:/config/
                """
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
            script {
                // 실패 시 컨테이너 로그 수집
                sh """
                    docker logs ${DOCKER_CONTAINER_NAME} || echo "No container logs available"
                """
            }
        }
        always {
            echo 'always'

            script {
                // if (isUnix()) {}
                // Docker 정리
                sh """
                    docker image prune -f
                    docker buildx prune -f
                """
                // 워크스페이스 정리
                cleanWs()

                // 빌드 정보 출력
                echo "Build completed with result: ${currentBuild.result}"
                echo "Build duration: ${currentBuild.durationString}"
            }
        }
    }
}